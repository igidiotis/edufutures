<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Futures Generator - Interactive Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .draggable {
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .draggable:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .drop-zone {
            transition: background-color 0.3s, border-color 0.3s;
        }
        .drop-zone.highlight {
            background-color: #e6f7ff;
            border-color: #1890ff;
        }
        .item-in-zone {
            position: relative;
            z-index: 10;
            cursor: pointer;
        }
        
        .remove-card-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            color: #f56565;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #f56565;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .item-in-zone:hover .remove-card-btn {
            opacity: 1;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Card color schemes */
        .arc-card { 
            background-color: #90EE90; 
            background-image: linear-gradient(45deg, #90EE90, #98FB98);
        }
        .object-card { 
            background-color: #87CEEB; 
            background-image: linear-gradient(45deg, #87CEEB, #B0E0E6);
        }
        .terrain-card { 
            background-color: #FFB6C1; 
            background-image: linear-gradient(45deg, #FFB6C1, #FFA07A);
        }
        .mood-card { 
            background-color: #DDA0DD; 
            background-image: linear-gradient(45deg, #DDA0DD, #EE82EE);
        }
        
        /* Card icon backgrounds */
        .arc-icon {
            background-color: rgba(0, 128, 0, 0.3);
        }
        .object-icon {
            background-color: rgba(0, 0, 128, 0.3);
        }
        .terrain-icon {
            background-color: rgba(128, 0, 0, 0.3);
        }
        .mood-icon {
            background-color: rgba(128, 0, 128, 0.3);
        }
        
        /* Consent dropdown styling */
        .consent-content {
            display: none;
            position: absolute;
            background-color: #ffffff;
            min-width: 300px;
            max-width: 600px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            z-index: 100;
            text-align: left;
            left: 50%;
            transform: translateX(-50%);
        }

        .consent-dropdown:hover .consent-content {
            display: block;
        }
        
        /* Spinner animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin-animation {
            animation: spin 1s linear;
        }
        
        /* Step indicators */
        .step-indicator {
            position: relative;
            z-index: 10;
        }
        
        .step-bubble {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        .step-connector {
            height: 3px;
            flex-grow: 1;
            transition: background-color 0.3s ease;
        }
        
        .step-content {
            opacity: 0;
            display: none;
            transition: opacity 0.5s ease;
        }
        
        .step-content.active {
            opacity: 1;
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        /* Option cards in Step 2 */
        .option-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .option-card.selected {
            border-color: #4CAF50;
        }

        /* Help modal */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
        
        .modal-backdrop.show {
            display: block;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            margin: 100px auto;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-800">Education Futures Generator</h1>
            <p class="mt-2 text-gray-600 max-w-3xl mx-auto">
                This interactive generator is based on 'The Thing From the Future', an imagination game meant to spur creative and critical thinking about educational futures.
            </p>
            <div class="consent-dropdown mt-4">
                <button class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-gray-700">
                    Research Participation Information â–¼
                </button>
                <div class="consent-content">
                    <h3 class="text-lg font-semibold mb-3">Consent to Participate in Research; read more <a href="https://igidiotis.github.io/edfutures/research-consent.html" target="_blank" class="text-green-600 hover:underline">here</a></h3>
                    
                    <p class="mb-2"><strong>Purpose:</strong> You are invited to share a short speculative story based on four generated elements. This research explores how educators and stakeholders imagine AI's socio-technical impact on future learning.</p>
                    
                    <p class="mb-2"><strong>What You Will Do:</strong> You will receive four elements and submit your brief story through a form embedded in the creation tool below.</p>
                    
                    <p class="mb-2"><strong>Data Usage & Privacy:</strong></p>
                    <ul class="list-disc pl-5 mb-2">
                        <li>Your story is used for research only.</li>
                        <li>We collect no personal identifiers unless you voluntarily provide contact details for further participation.</li>
                        <li>Stories are anonymous; your email is optional and used only if you wish to be further contacted.</li>
                        <li>Quotes may appear in publications and presentations, without identifying information.</li>
                    </ul>
                    
                    <p class="mb-2"><strong>Voluntary Participation:</strong> You can stop your participation at any time.</p>
                    
                    <p class="mb-2"><strong>Withdrawal Rights:</strong> To remove your story, email 
                        <a href="mailto:gidiotis@kth.se" class="text-green-600 hover:underline">gidiotis@kth.se</a> with its submission timestamp.
                    </p>
                    
                    <p class="mb-2"><strong>Data Storage:</strong> Your story will be stored securely and viewed only by the research team.</p>
                    
                    <p class="mb-2"><strong>Questions:</strong> Contact <a href="mailto:gidiotis@kth.se" class="text-green-600 hover:underline">gidiotis@kth.se</a> for more information.</p>
                    
                    <p class="italic mt-4">By submitting a story, you confirm you have read this information and consent to participate under these terms.</p>
                </div>
            </div>
        </div>

        <!-- Step Indicators -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div class="step-indicator flex items-center w-full">
                    <div class="step-bubble bg-blue-500 text-white">1</div>
                    <div class="step-connector bg-gray-300 mx-2"></div>
                    <div class="step-bubble bg-gray-300 text-gray-700">2</div>
                    <div class="step-connector bg-gray-300 mx-2"></div>
                    <div class="step-bubble bg-gray-300 text-gray-700">3</div>
                </div>
            </div>
            <div class="flex justify-between text-sm mt-2 text-gray-600">
                <div class="w-1/3 text-center text-blue-600 font-medium">Build Scenario</div>
                <div class="w-1/3 text-center">Create Story</div>
                <div class="w-1/3 text-center">Share Feedback</div>
            </div>
        </div>

        <!-- Step 1: Build Scenario -->
        <div id="step1" class="step-content active">
            <!-- Instructions -->
            <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold mb-2 text-gray-800">Step 1: Build Your Future Scenario</h2>
                <p class="text-gray-700">
                    Create your education scenario by <strong>dragging cards</strong> into the corresponding drop zones. You can use the shuffle button to get different options for each element.
                </p>
                <p class="text-gray-700 mt-2">
                    <strong>Note:</strong> You can click on a placed card to remove it if you want to try a different option.
                </p>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <!-- Arc Section -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- Arc Cards -->
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-medium text-gray-700 flex items-center">
                                    <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                                    ARC Elements
                                </h3>
                                <button class="shuffle-btn p-1 rounded-full hover:bg-gray-100" data-type="arc">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                            </div>
                            <div id="arcCollection" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <!-- Arc cards will be generated here -->
                            </div>
                        </div>
                        
                        <!-- Arc Drop Zone -->
                        <div class="flex-1 flex items-center">
                            <div id="arcDropZone" class="drop-zone bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-4 h-full w-full min-h-[100px] flex items-center justify-center" data-type="arc">
                                <div class="text-center">
                                    <div class="w-12 h-12 arc-icon rounded-full flex items-center justify-center mx-auto mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    <p class="text-gray-500">Drag an ARC card here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Object Section -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- Object Cards -->
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-medium text-gray-700 flex items-center">
                                    <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                                    OBJECT Elements
                                </h3>
                                <button class="shuffle-btn p-1 rounded-full hover:bg-gray-100" data-type="object">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                            </div>
                            <div id="objectCollection" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <!-- Object cards will be generated here -->
                            </div>
                        </div>
                        
                        <!-- Object Drop Zone -->
                        <div class="flex-1 flex items-center">
                            <div id="objectDropZone" class="drop-zone bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-4 h-full w-full min-h-[100px] flex items-center justify-center" data-type="object">
                                <div class="text-center">
                                    <div class="w-12 h-12 object-icon rounded-full flex items-center justify-center mx-auto mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                    <p class="text-gray-500">Drag an OBJECT card here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Terrain Section -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- Terrain Cards -->
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-medium text-gray-700 flex items-center">
                                    <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
                                    TERRAIN Elements
                                </h3>
                                <button class="shuffle-btn p-1 rounded-full hover:bg-gray-100" data-type="terrain">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                            </div>
                            <div id="terrainCollection" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <!-- Terrain cards will be generated here -->
                            </div>
                        </div>
                        
                        <!-- Terrain Drop Zone -->
                        <div class="flex-1 flex items-center">
                            <div id="terrainDropZone" class="drop-zone bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-4 h-full w-full min-h-[100px] flex items-center justify-center" data-type="terrain">
                                <div class="text-center">
                                    <div class="w-12 h-12 terrain-icon rounded-full flex items-center justify-center mx-auto mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <p class="text-gray-500">Drag a TERRAIN card here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mood Section -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- Mood Cards -->
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-medium text-gray-700 flex items-center">
                                    <div class="w-4 h-4 bg-purple-500 rounded-full mr-2"></div>
                                    MOOD Elements
                                </h3>
                                <button class="shuffle-btn p-1 rounded-full hover:bg-gray-100" data-type="mood">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                            </div>
                            <div id="moodCollection" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <!-- Mood cards will be generated here -->
                            </div>
                        </div>
                        
                        <!-- Mood Drop Zone -->
                        <div class="flex-1 flex items-center">
                            <div id="moodDropZone" class="drop-zone bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-4 h-full w-full min-h-[100px] flex items-center justify-center" data-type="mood">
                                <div class="text-center">
                                    <div class="w-12 h-12 mood-icon rounded-full flex items-center justify-center mx-auto mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <p class="text-gray-500">Drag a MOOD card here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-6">
                    <button class="py-2 px-4 bg-gray-200 text-gray-400 rounded-lg cursor-not-allowed" disabled>
                        Back
                    </button>
                    <button id="nextToStep2" class="py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Next: Create Story
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Create Story (Enhanced with 3 options) -->
        <div id="step2" class="step-content">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Step 2: Create Your Future Story</h2>
                
                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-2">Your selected elements:</h3>
                    <ul id="elementsList" class="list-disc pl-5 text-gray-600 bg-gray-50 p-4 rounded-lg"></ul>
                </div>
                
                <!-- Story Creation Options -->
                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-4">Choose how you want to create your story:</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Option 1: Generate from JSON -->
                        <div id="option-generate" class="option-card bg-green-50 p-4 rounded-lg shadow hover:shadow-lg text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                </svg>
                            </div>
                            <h4 class="text-lg font-medium text-gray-800 mb-2">Generate Story</h4>
                            <p class="text-gray-600 text-sm">Use pre-created stories that match your scenario elements.</p>
                        </div>
                        
                        <!-- Option 2: AI Generated -->
                        <div id="option-ai" class="option-card bg-blue-50 p-4 rounded-lg shadow hover:shadow-lg text-center">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                </svg>
                            </div>
                            <h4 class="text-lg font-medium text-gray-800 mb-2">Generate AI Story</h4>
                            <p class="text-gray-600 text-sm">Use AI to create a unique story based on your elements.</p>
                        </div>
                        
                        <!-- Option 3: Write Your Own -->
                        <div id="option-write" class="option-card bg-purple-50 p-4 rounded-lg shadow hover:shadow-lg text-center">
                            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </div>
                            <h4 class="text-lg font-medium text-gray-800 mb-2">Write Your Own Story</h4>
                            <p class="text-gray-600 text-sm">Create your own narrative with helpful writing prompts.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Option Content Areas - Each one will be shown/hidden based on selection -->
                
                <!-- 1. Generate Story Content -->
                <div id="generate-content" class="option-content hidden">
                    <div class="mb-6 text-center">
                        <button id="generateStoryBtn" class="w-full py-3 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-lg">
                            Generate Story from Library
                        </button>
                    </div>
                    
                    <div id="generatedStoryContainer" class="mb-6 hidden">
                        <h3 class="font-medium text-gray-700 mb-2">Your Generated Story:</h3>
                        <div id="generatedStoryText" class="bg-green-50 p-4 rounded-lg text-gray-700"></div>
                    </div>
                </div>
                
                <!-- 2. AI Story Content -->
                <div id="ai-content" class="option-content hidden">
                    <div class="mb-6 text-center">
                        <button id="aiGenerateBtn" class="w-full py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-lg">
                            Generate AI Story
                        </button>
                    </div>
                    
                    <!-- AI Loading Indicator -->
                    <div id="aiLoading" class="mb-6 text-center p-6 hidden">
                        <div class="w-12 h-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-gray-600">Generating your future scenario...</p>
                    </div>
                    
                    <!-- AI Generated Content -->
                    <div id="aiContent" class="mb-6 hidden">
                        <h3 class="font-medium text-gray-700 mb-2">Your AI-Generated Story:</h3>
                        <div id="aiScenarioText" class="bg-blue-50 p-4 rounded-lg text-gray-700"></div>
                    </div>
                </div>
                
                <!-- 3. Write Your Own Content -->
                <div id="write-content" class="option-content hidden">
                    <div class="mb-4">
                        <h3 class="font-medium text-gray-700 mb-2">Write your story below:</h3>
                        <textarea id="userStory" class="w-full min-h-[300px] p-4 border border-gray-300 rounded-lg resize-y focus:outline-none focus:ring-2 focus:ring-purple-600" placeholder="Start developing your scenario here..."></textarea>
                        <div class="mt-2 flex justify-between text-sm text-gray-600">
                            <span id="charCount">Characters: 0 / 5000</span>
                            <span id="wordCount">Words: 0</span>
                        </div>
                    </div>
                    
                    <!-- Suggestion Buttons -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors" onclick="getSuggestion('arc')">ARC Help</button>
                        <button class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors" onclick="getSuggestion('object')">OBJECT Help</button>
                        <button class="bg-pink-500 text-white py-2 px-4 rounded-lg hover:bg-pink-600 transition-colors" onclick="getSuggestion('terrain')">TERRAIN Help</button>
                        <button class="bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 transition-colors" onclick="getSuggestion('mood')">MOOD Help</button>
                        <button class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors" onclick="clearSuggestion()">Clear Suggestion</button>
                        <button class="bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors" onclick="openHelpModal()">Writing Tips</button>
                    </div>
                    
                    <div id="suggestionText" class="bg-purple-50 p-4 rounded-lg text-gray-700 mb-4 hidden"></div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-8">
                    <button id="backToStep1" class="py-2 px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors">
                        Back: Build Scenario
                    </button>
                    <button id="nextToStep3" class="py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Next: Share Feedback
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Feedback -->
        <div id="step3" class="step-content">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Step 3: Share Your Feedback</h2>
                
                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-2">Your story:</h3>
                    <div id="scenarioSummary" class="bg-blue-50 p-4 rounded-lg text-gray-700"></div>
                </div>
                
                <!-- Enhanced Research Quiz -->
                <div class="space-y-6 mb-6">
                    <h3 class="font-medium text-gray-700 text-lg">Research Questions:</h3>
                    
                    <!-- Question 1 -->
                    <div>
                        <label for="q1" class="block text-gray-700 mb-2">
                            1. How realistic do you find this educational scenario for 2045?
                        </label>
                        <select id="q1" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Select your answer --</option>
                            <option value="Very unrealistic">Very unrealistic</option>
                            <option value="Somewhat unrealistic">Somewhat unrealistic</option>
                            <option value="Neither realistic nor unrealistic">Neither realistic nor unrealistic</option>
                            <option value="Somewhat realistic">Somewhat realistic</option>
                            <option value="Very realistic">Very realistic</option>
                        </select>
                    </div>
                    
                    <!-- Question 2 -->
                    <div>
                        <label for="q2" class="block text-gray-700 mb-2">
                            2. What aspects of this scenario do you find most promising for the future of education?
                        </label>
                        <textarea id="q2" class="w-full h-24 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Share your thoughts..."></textarea>
                    </div>
                    
                    <!-- Question 3 -->
                    <div>
                        <label for="q3" class="block text-gray-700 mb-2">
                            3. What potential concerns or ethical issues does this scenario raise?
                        </label>
                        <textarea id="q3" class="w-full h-24 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Share your thoughts..."></textarea>
                    </div>
                    
                    <!-- Question 4 -->
                    <div>
                        <label for="q4" class="block text-gray-700 mb-2">
                            4. How might this scenario impact different groups of learners (considering accessibility, equity, etc.)?
                        </label>
                        <textarea id="q4" class="w-full h-24 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Share your thoughts..."></textarea>
                    </div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-8">
                    <button id="backToStep2" class="py-2 px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors">
                        Back: Create Story
                    </button>
                    <button id="submitToTally" class="py-2 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors" disabled>
                        Submit Responses
                    </button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal-backdrop">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Writing Tips for Your Future Scenario</h3>
                    <button class="text-gray-600 hover:text-gray-800 text-2xl" onclick="closeHelpModal()">&times;</button>
                </div>
                <ul class="list-disc pl-5 text-gray-700">
                    <li><strong>Set the Scene:</strong> Begin by describing how this future looks and feels. What's different from today? What's familiar?</li>
                    <li><strong>Focus on the Object:</strong> Explain how people interact with the mentioned object. What problems does it solve? What new challenges might it create?</li>
                    <li><strong>Consider the Context:</strong> Think about how the TERRAIN affects the story. How does the specified context influence people's behaviors and interactions?</li>
                    <li><strong>Capture the Mood:</strong> Reflect the emotional atmosphere in your writing. How do people feel about living in this future?</li>
                    <li><strong>Include Characters:</strong> Consider introducing a character experiencing this future. What's their perspective on these changes?</li>
                    <li><strong>Educational Impact:</strong> Think about how learning and teaching have evolved. What new possibilities or challenges exist?</li>
                    <li><strong>Show, Don't Tell:</strong> Instead of just stating facts, create vivid descriptions and specific examples of how this future works.</li>
                    <li><strong>Consider Consequences:</strong> What are the broader implications of this future for society, culture, and human relationships?</li>
                </ul>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center border-t border-gray-300 pt-4 mt-6">
            <p class="text-gray-600">
                Created by <a href="https://www.kth.se/profile/gidiotis" target="_blank" class="text-green-600 hover:underline">Iosif Gidiotis</a>
            </p>
            <p class="text-gray-600">
                <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" class="text-green-600 hover:underline">CC BY-NC-SA 4.0</a>
            </p>
        </footer>
    </div>

    <script>
        // Card content data
        const arcs = [
            "In a future where AI tutors enhance 80% of human teaching",
            "In a future where global learning networks connect every village",
            "In a future where brain-computer interfaces accelerate learning",
            "In a future where education is free and universally accessible",
            "In a future where lifelong learning is the educational standard",
            "In a future where tech failures have disrupted digital education",
            "In a future where learning gaps have created knowledge tribes",
            "In a future where attention disorders affect 70% of students",
            "In a future where schools struggle with constant power outages",
            "In a future where education access depends on data wealth",
            "In a future where learning happens through shared dreaming",
            "In a future where education adapts to planetary migration",
            "In a future where skills are traded like currencies",
            "In a future where learning is embedded in daily survival",
            "In a future where human and AI consciousness co-evolve"
        ];

        const objects = [
            "there exists an AI that reads facial expressions",
            "there exists a neural headband that transfers language skills in hours",
            "there exists a hologram teacher who can split into 30 versions of itself",
            "there exists an algorithm that predicts optimal learning pathways",
            "there exists a VR system that recreates any historical moment",
            "there exists an AI that provides feedback in a student's learning style",
            "there exists a network where 10,000 minds solve problems together",
            "there exists a tool that adjusts content difficulty in real-time",
            "there exists an AI matchmaker connecting learners across cultures",
            "there exists a system that identifies knowledge gaps before they form",
            "there exists an AR classroom that adapts to each student's needs",
            "there exists a simulator that generates real-world projects",
            "there exists an AI that matches peer tutors with 99% accuracy",
            "there exists a device that visualizes thinking patterns"
        ];

        const terrains = [
            "in a context where DNA analysis predicts optimal learning paths",
            "in a context where learning groups are formed based on skill level",
            "in a context where city infrastructure doubles as learning spaces",
            "in a context where students grade each other using AI frameworks",
            "in a context where AI tutors provide 24/7 personalized support",
            "in a context where textbooks update themselves daily",
            "in a context where neighborhood learning hubs replace schools",
            "in a context where mistakes earn achievement badges",
            "in a context where learning happens across physical and digital realms",
            "in a context where devices reshape to match learning styles",
            "in a context where social interactions earn learning credits"
        ];

        const moods = [
            "with wonder and curiosity",
            "with collaborative excitement",
            "with playful confidence",
            "with quiet determination",
            "with creative energy",
            "with gentle optimism",
            "with cautious hope",
            "with reflective patience",
            "with balanced acceptance",
            "with mindful hesitation",
            "with respectful concern",
            "with thoughtful resistance"
        ];

        // Suggestion arrays for each category
        const arcSuggestions = [
            "How does this future change the way people learn?",
            "What challenges might educators face in this future?",
            "How could this future impact social equality in education?",
            "What new opportunities does this future create for students?",
            "How might this future affect the role of human teachers?"
        ];
        const objectSuggestions = [
            "How do people interact with this object daily?",
            "What problems does this object solve in education?",
            "What new challenges might this object introduce?",
            "How does this object change the learning experience?",
            "Who benefits most from using this object?"
        ];
        const terrainSuggestions = [
            "How does this context influence student behavior?",
            "What advantages does this context offer for learning?",
            "How might this context limit educational access?",
            "How do people adapt to this context in daily life?",
            "What technologies are essential in this context?"
        ];
        const moodSuggestions = [
            "How can you reflect this mood in your characters' actions?",
            "What elements of the scenario contribute to this mood?",
            "How does this mood affect the perception of the future?",
            "How might this mood influence educational outcomes?",
            "What conflicts could arise due to this mood?"
        ];

        // Track the selected cards
        let selectedCards = {
            arc: null,
            object: null,
            terrain: null,
            mood: null
        };

        // Track steps and story choices
        let currentStep = 1;
        let storyGenerated = false;
        let selectedStoryOption = null;
        let finalStory = "";
        let storySource = "";

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeCards();
            setupDragAndDrop();
            setupNavigationButtons();
            setupShuffleButtons();
            setupStoryOptions();
            setupWritingHelpers();
        });

        // Generate initial cards for each collection
        function initializeCards() {
            generateCardsForCollection('arcCollection', arcs, 'arc');
            generateCardsForCollection('objectCollection', objects, 'object');
            generateCardsForCollection('terrainCollection', terrains, 'terrain');
            generateCardsForCollection('moodCollection', moods, 'mood');
        }

        // Generate cards for a specific collection
        function generateCardsForCollection(collectionId, items, cardType) {
            const collection = document.getElementById(collectionId);
            collection.innerHTML = ''; // Clear existing cards
            
            // Take 2 random items from the array
            const selectedItems = getRandomItems(items, 2);
            
            selectedItems.forEach(item => {
                const card = document.createElement('div');
                card.className = `draggable p-3 rounded-lg ${cardType}-card shadow-sm`;
                card.draggable = true;
                card.dataset.type = cardType;
                card.dataset.content = item;
                
                card.innerHTML = `<p class="text-sm font-medium">${item}</p>`;
                
                collection.appendChild(card);
            });
        }

        // Set up shuffle buttons
        function setupShuffleButtons() {
            document.querySelectorAll('.shuffle-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const cardType = this.dataset.type;
                    const shuffleIcon = this.querySelector('svg');
                    
                    // Add spin animation
                    shuffleIcon.classList.add('spin-animation');
                    
                    // After animation, remove the class
                    setTimeout(() => {
                        shuffleIcon.classList.remove('spin-animation');
                    }, 1000);
                    
                    // Generate new cards for this type
                    shuffleCards(cardType);
                });
            });
        }

        // Shuffle cards for a specific type
        function shuffleCards(cardType) {
            const collections = {
                'arc': { id: 'arcCollection', items: arcs },
                'object': { id: 'objectCollection', items: objects },
                'terrain': { id: 'terrainCollection', items: terrains },
                'mood': { id: 'moodCollection', items: moods }
            };
            
            if (collections[cardType]) {
                generateCardsForCollection(
                    collections[cardType].id,
                    collections[cardType].items,
                    cardType
                );
            }
        }

        // Set up navigation buttons
        function setupNavigationButtons() {
            // Step 1 to Step 2
            document.getElementById('nextToStep2').addEventListener('click', function() {
                goToStep(2);
                updateElementsList();
            });
            
            // Step 2 to Step 1
            document.getElementById('backToStep1').addEventListener('click', function() {
                goToStep(1);
            });
            
            // Step 2 to Step 3
            document.getElementById('nextToStep3').addEventListener('click', function() {
                goToStep(3);
                
                // Copy scenario summary to Step 3
                document.getElementById('scenarioSummary').innerHTML = finalStory;
                
                // Enable submit button only when all questions have answers
                checkQuizCompletion();
            });
            
            // Step 3 to Step 2
            document.getElementById('backToStep2').addEventListener('click', function() {
                goToStep(2);
            });
            
            // Submit button
            document.getElementById('submitToTally').addEventListener('click', submitToTallyForm);
            
            // Quiz validation
            document.querySelectorAll('#q1, #q2, #q3, #q4').forEach(element => {
                element.addEventListener('change', checkQuizCompletion);
                element.addEventListener('keyup', checkQuizCompletion);
            });
        }

        // Setup story option selection
        function setupStoryOptions() {
            // Option cards
            const optionCards = document.querySelectorAll('.option-card');
            optionCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Remove selected class from all cards
                    optionCards.forEach(c => c.classList.remove('selected'));
                    
                    // Add selected class to clicked card
                    this.classList.add('selected');
                    
                    // Hide all option content areas
                    document.querySelectorAll('.option-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show selected option content
                    const optionId = this.id;
                    selectedStoryOption = optionId.replace('option-', '');
                    document.getElementById(`${selectedStoryOption}-content`).classList.remove('hidden');
                    
                    // Enable/disable next button based on selection
                    document.getElementById('nextToStep3').disabled = true;
                });
            });
            
            // Generate story button (pre-generated JSON)
            document.getElementById('generateStoryBtn').addEventListener('click', generatePrewrittenStory);
            
            // AI Generate button
            document.getElementById('aiGenerateBtn').addEventListener('click', generateAIStory);
            
            // User story textarea
            document.getElementById('userStory').addEventListener('input', function() {
                updateCounts();
                // Enable next button if there's content
                document.getElementById('nextToStep3').disabled = this.value.trim().length === 0;
                
                // Save the story as final story
                finalStory = this.value;
                storySource = "user-written";
            });
        }

        // Set up writing helpers (suggestions, character count, etc.)
        function setupWritingHelpers() {
            // Character and word count
            document.getElementById('userStory').addEventListener('input', updateCounts);
        }

        // Generate pre-written story from a JSON library
        function generatePrewrittenStory() {
            // Simulate fetching from a JSON file (in production, this would be a real fetch)
            setTimeout(() => {
                // Generate a story based on the elements
                const storyStart = generateStoryStart();
                const storyMiddle = generateStoryMiddle();
                const storyEnd = generateStoryEnd();
                
                const story = `
                    <p class="mb-3">${storyStart}</p>
                    <p class="mb-3">${storyMiddle}</p>
                    <p>${storyEnd}</p>
                `;
                
                // Show the generated story
                document.getElementById('generatedStoryContainer').classList.remove('hidden');
                document.getElementById('generatedStoryText').innerHTML = story;
                
                // Enable the next button
                document.getElementById('nextToStep3').disabled = false;
                
                // Save story as final story
                finalStory = story;
                storySource = "pre-generated";
            }, 1000);
        }

        // Generate AI story
        function generateAIStory() {
            // Show AI loading indicator
            document.getElementById('aiLoading').classList.remove('hidden');
            
            // Hide AI content while loading
            document.getElementById('aiContent').classList.add('hidden');
            
            // This is a placeholder for the future API call
            // In a real implementation, this would call your Vercel API
            setTimeout(() => {
                // Hide loading indicator
                document.getElementById('aiLoading').classList.add('hidden');
                
                // Show AI content
                document.getElementById('aiContent').classList.remove('hidden');
                
                // Set placeholder content (this would be replaced by the actual API response)
                const aiScenarioText = document.getElementById('aiScenarioText');
                
                const storyStart = generateStoryStart();
                const storyMiddle = generateStoryMiddle();
                const storyEnd = generateStoryEnd();
                
                const story = `
                    <p class="mb-3">${storyStart}</p>
                    <p class="mb-3">${storyMiddle}</p>
                    <p>${storyEnd}</p>
                `;
                
                aiScenarioText.innerHTML = story;
                
                // Enable next button
                document.getElementById('nextToStep3').disabled = false;
                
                // Save story as final story
                finalStory = story;
                storySource = "ai-generated";
            }, 2000); // Simulate API delay
        }

        // Navigate to a specific step
        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show the target step
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update step indicators
            updateStepIndicators(step);
            
            // Update current step
            currentStep = step;
        }

        // Update step indicators
        function updateStepIndicators(activeStep) {
            // Get all step bubbles and connectors
            const stepBubbles = document.querySelectorAll('.step-bubble');
            const stepConnectors = document.querySelectorAll('.step-connector');
            
            // Reset all to inactive state
            stepBubbles.forEach((bubble, index) => {
                if (index + 1 < activeStep) {
                    // Completed steps
                    bubble.className = 'step-bubble bg-green-500 text-white';
                } else if (index + 1 === activeStep) {
                    // Current step
                    bubble.className = 'step-bubble bg-blue-500 text-white';
                } else {
                    // Future steps
                    bubble.className = 'step-bubble bg-gray-300 text-gray-700';
                }
            });
            
            // Update step text colors
            const stepTexts = document.querySelectorAll('.step-indicator + div > div');
            stepTexts.forEach((text, index) => {
                if (index + 1 < activeStep) {
                    text.className = 'w-1/3 text-center text-green-600 font-medium';
                } else if (index + 1 === activeStep) {
                    text.className = 'w-1/3 text-center text-blue-600 font-medium';
                } else {
                    text.className = 'w-1/3 text-center text-gray-600';
                }
            });
            
            // Update connectors
            stepConnectors.forEach((connector, index) => {
                if (index + 1 < activeStep) {
                    connector.className = 'step-connector bg-green-500 mx-2';
                } else {
                    connector.className = 'step-connector bg-gray-300 mx-2';
                }
            });
        }

        // Get random items from an array
        function getRandomItems(array, count) {
            const shuffled = [...array].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // Set up drag and drop functionality
        function setupDragAndDrop() {
            // Make cards draggable
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('draggable')) {
                    e.dataTransfer.setData('text/plain', e.target.dataset.content);
                    e.dataTransfer.setData('cardType', e.target.dataset.type);
                    
                    // Add visual cue for dragging
                    setTimeout(() => {
                        e.target.classList.add('opacity-50');
                    }, 0);
                }
            });

            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('draggable')) {
                    e.target.classList.remove('opacity-50');
                }
            });

            // Set up drop zones
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const cardType = e.dataTransfer.getData('cardType') || e.dataTransfer.types.includes('text/plain') && zone.dataset.type;
                    
                    if (zone.dataset.type === cardType || !cardType) {
                        this.classList.add('highlight');
                    }
                });

                zone.addEventListener('dragleave', function() {
                    this.classList.remove('highlight');
                });

                zone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('highlight');
                    
                    const cardContent = e.dataTransfer.getData('text/plain');
                    const cardType = e.dataTransfer.getData('cardType');
                    
                    if (cardType === this.dataset.type) {
                        // Clear the drop zone
                        this.innerHTML = '';
                        
                        // Create a new card in the drop zone
                        const card = document.createElement('div');
                        card.className = `item-in-zone p-4 ${cardType}-card rounded-lg shadow-md`;
                        card.dataset.type = cardType;
                        card.dataset.content = cardContent;
                        
                        card.innerHTML = `
                            <div class="flex items-center relative">
                                <div class="remove-card-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </div>
                                <div class="w-10 h-10 ${cardType}-icon rounded-full flex items-center justify-center mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <p class="text-sm font-medium">${cardContent}</p>
                            </div>
                        `;
                        
                        // Add click event to remove the card
                        card.addEventListener('click', function() {
                            removeCard(this);
                        });
                        
                        this.appendChild(card);
                        
                        // Update selected cards
                        selectedCards[cardType] = cardContent;
                        
                        // Check if all cards are selected
                        checkAllCardsSelected();
                    }
                });
            });
        }

        // Remove a card from a drop zone
        function removeCard(card) {
            const cardType = card.dataset.type;
            const dropZone = card.parentElement;
            
            // Reset the drop zone to its original state
            const emptyDropZone = `
                <div class="text-center">
                    <div class="w-12 h-12 ${cardType}-icon rounded-full flex items-center justify-center mx-auto mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                    <p class="text-gray-500">Drag a ${cardType.toUpperCase()} card here</p>
                </div>
            `;
            
            dropZone.innerHTML = emptyDropZone;
            
            // Update selected cards
            selectedCards[cardType] = null;
            
            // Check if all cards are selected (this will disable the next button if needed)
            checkAllCardsSelected();
        }

        // Check if all cards are selected
        function checkAllCardsSelected() {
            const allSelected = Object.values(selectedCards).every(value => value !== null);
            
            // Enable/disable next button
            document.getElementById('nextToStep2').disabled = !allSelected;
            
            // If all selected, make the next button more prominent
            if (allSelected) {
                document.getElementById('nextToStep2').classList.add('animate-pulse');
                setTimeout(() => {
                    document.getElementById('nextToStep2').classList.remove('animate-pulse');
                }, 1500);
            }
        }

        // Update the elements list in step 2
        function updateElementsList() {
            const elementsList = document.getElementById('elementsList');
            elementsList.innerHTML = '';
            
            Object.entries(selectedCards).forEach(([type, content]) => {
                if (content) {
                    const li = document.createElement('li');
                    li.className = 'mb-1';
                    li.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${content}`;
                    elementsList.appendChild(li);
                }
            });
        }

        // Update character and word counts
        function updateCounts() {
            const text = document.getElementById('userStory').value;
            const charCount = text.length;
            const wordCount = text.trim().split(/\s+/).filter(word => word.length).length || 0;
            document.getElementById('charCount').textContent = `Characters: ${charCount} / 5000`;
            document.getElementById('wordCount').textContent = `Words: ${wordCount}`;
        }

        // Get suggestion for writing help
        function getSuggestion(category) {
            const suggestionArrays = {
                arc: arcSuggestions,
                object: objectSuggestions,
                terrain: terrainSuggestions,
                mood: moodSuggestions
            };
            
            const suggestions = suggestionArrays[category];
            const suggestion = getRandomItem(suggestions, 1)[0];
            const suggestionText = document.getElementById('suggestionText');
            suggestionText.textContent = `Suggestion for ${category.toUpperCase()}: ${suggestion}`;
            suggestionText.classList.remove('hidden');
        }

        // Clear suggestion
        function clearSuggestion() {
            const suggestionText = document.getElementById('suggestionText');
            suggestionText.classList.add('hidden');
            suggestionText.textContent = '';
        }

        // Open help modal
        function openHelpModal() {
            document.getElementById('helpModal').classList.add('show');
        }

        // Close help modal
        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('show');
        }

        // Helper function to generate a random story start
        function generateStoryStart() {
            const starts = [
                `In 2045, education had been transformed by ${getTypeElement('object')}. Professor Mei Zhang welcomed her students to the morning session at Singapore's Central Learning Hub, where ${getTypeElement('arc').toLowerCase()}.`,
                
                `The year was 2045. Liam adjusted his neural interface as he prepared for today's lesson. Since ${getTypeElement('arc').toLowerCase()}, students like him had adapted to new ways of learning.`,
                
                `Ava looked out over the cityscape of 2045, a world where ${getTypeElement('arc').toLowerCase()}. She activated ${getTypeElement('object').replace('there exists ', '')}, preparing for another day of learning.`
            ];
            
            return starts[Math.floor(Math.random() * starts.length)];
        }

        // Helper function to generate a random story middle
        function generateStoryMiddle() {
            const middles = [
                `The classroom environment was unlike anything from decades past, as ${getTypeElement('terrain').toLowerCase()}. Students connected with each other ${getTypeElement('mood').toLowerCase()}, sharing insights across continents in real-time.`,
                
                `${getTypeElement('terrain')} had created unprecedented opportunities. Today's lesson flowed naturally as students engaged with the material ${getTypeElement('mood').toLowerCase()}, unrestrained by the physical limitations that had once defined education.`,
                
                `What made this system revolutionary was how ${getTypeElement('terrain').toLowerCase()}. The traditional boundaries between subjects had dissolved, and learners approached new challenges ${getTypeElement('mood').toLowerCase()}.`
            ];
            
            return middles[Math.floor(Math.random() * middles.length)];
        }

        // Helper function to generate a random story end
        function generateStoryEnd() {
            const ends = [
                `As the session concluded, everyone reflected on how different education had become. The combination of ${getTypeElement('object').replace('there exists ', '')} with an environment where ${getTypeElement('arc').toLowerCase()} had created learning experiences that previous generations could only have dreamed of.`,
                
                `Looking back at the educational systems of the 2020s, it seemed primitive by comparison. The integration of technology and human connection had finally reached a balance, allowing students to approach knowledge ${getTypeElement('mood').toLowerCase()} while developing the skills they truly needed.`,
                
                `This was the promise of future education fulfilled - not just more efficient learning, but deeper, more meaningful connections to knowledge. In this world where ${getTypeElement('arc').toLowerCase()}, students no longer just studied the worldâ€”they engaged with it directly, personally, and profoundly.`
            ];
            
            return ends[Math.floor(Math.random() * ends.length)];
        }

        // Helper function to get the content of a specific card type
        function getTypeElement(type) {
            return selectedCards[type] || `[${type} element]`;
        }

        // Check if the quiz is complete
        function checkQuizCompletion() {
            const q1 = document.getElementById('q1').value;
            const q2 = document.getElementById('q2').value;
            const q3 = document.getElementById('q3').value;
            const q4 = document.getElementById('q4').value;
            
            const allCompleted = q1 && q2 && q3 && q4;
            
            // Enable/disable submit button
            document.getElementById('submitToTally').disabled = !allCompleted;
            
            if (allCompleted) {
                document.getElementById('submitToTally').classList.add('animate-pulse');
                setTimeout(() => {
                    document.getElementById('submitToTally').classList.remove('animate-pulse');
                }, 1500);
            }
        }

        // Submit to Tally Form
        function submitToTallyForm() {
            // Get form values
            const q1 = document.getElementById('q1').value;
            const q2 = document.getElementById('q2').value;
            const q3 = document.getElementById('q3').value;
            const q4 = document.getElementById('q4').value;
            
            // Construct the Tally Form URL with parameters
            const baseURL = 'https://tally.so/r/3jk5vY'; // Replace with your actual Tally form ID
            
            // Using URLSearchParams
            const params = new URLSearchParams();
            params.set('arc', selectedCards.arc || '');
            params.set('object', selectedCards.object || '');
            params.set('terrain', selectedCards.terrain || '');
            params.set('mood', selectedCards.mood || '');
            params.set('story_source', storySource);
            
            // Get the generated story content
            const storyContent = finalStory.replace(/<\/?[^>]+(>|$)/g, ""); // Strip HTML tags
            
            params.set('story', storyContent);
            
            // Add quiz responses
            params.set('q1_realism', q1);
            params.set('q2_promising', q2);
            params.set('q3_concerns', q3);
            params.set('q4_impact', q4);
            
            // Open the form in a new tab
            window.open(`${baseURL}?${params.toString()}`, '_blank');
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-backdrop')) {
                event.target.classList.remove('show');
            }
        });

        // Close modals with Escape key
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal-backdrop').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });
    </script>
</body>
</html>
